<!-- Copyright Â© 2018 Andrey Mogilev. All rights reserved. -->
<!doctype html>
<html>
<head>
    <!--TODO: use 'min' or 'slim' versions!-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.css" rel="stylesheet" type="text/css" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">

    <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>-->
    <!--<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>

    <!-- Bootstrap -->
    <!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Bootstrap Select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>

    <style type="text/css">
        #mynetwork {
            width: 100%;
            height: 70vh;
            border: 1px solid lightgray;
        }
    </style>

    <title>SpringMX: Contexts Hierarchy</title>
</head>
<body>

<div class="container-fluid">

<h1>Contexts Hierarchy</h1>


<form>
    <div class="form-row">
        <div class="form-group col-md-2">
            <div class="row">
                <div class="col-md-12">
                    <label for="selApp">App</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                <select id="selApp" name="app" class="selectpicker form-control">
                    <option>Loading...</option>
                </select>
                </div>
            </div>
        </div>
        <div class="form-group col-md-6 offset-md-1">
            <div class="row">
                <div class="col-md-12">
                    <label for="selBean">Bean</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <select id="selBean" name="bean" class="selectpicker form-control" data-live-search="true">
                        <option>Loading...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

</form>

    <div id="mynetwork">
    </div>

</div>


<script type="text/javascript">

	// create a network
	var container = document.getElementById('mynetwork');

	var options = {
		layout : {
			hierarchical : {
				enabled : true,
				direction : 'LR',
                levelSeparation : 300
			}
        },
		groups : {
			app : { color:{background:'#ffffcc'}, level:0, title:"Web Application"},
			rootCtx : { color:{background:'#ffffcc'}, level:1, shape:'box'},
			childCtx : { color:{background:' #ffff80'}, level:2, shape:'box'},
			bean : { color:{background:'#f2f2f2'}, level:3, shape:'box', title:"Bean", },
            beanCluster : { color:{background:'#f2f2f2'}, level:3, shape:'box', title:"Beans Cluster", borderWidth:4, shadow:true},
        },
        edges : {
			arrows : {
				to : {
					enabled : true,
                    scaleFactor : 0.5
                }
			}
        },
        nodes : {
			font : {
				multi : 'html'
            }
        },
        physics : { enabled : false}
    };

    var networkData = {
        nodes : new vis.DataSet(),
        edges : new vis.DataSet(),
        update : function (data) {
            this.nodes.clear();
            this.nodes.add(data.nodes);
            this.edges.clear();
            this.edges.add(data.edges);
        }
    };
	var network = new vis.Network(container, networkData, options);

	var $selApp = $("#selApp"), $selBean = $("#selBean");
    var filterAppName = null, filterBeanId = null;

	network.on('doubleClick', function(params) {
        if (params.nodes.length === 1) {
            var nodeId = params.nodes[0];
            if (network.isCluster(nodeId)) {
                network.openCluster(nodeId);
            } else {
                var n = networkData.nodes.get(nodeId);
                if (n.group === 'rootCtx' || n.group === 'childCtx') {
                    clusterContextBeans(n);
                } else if (n.group === 'bean') {
                    window.open('/smxs/bean/' + encodeURIComponent(n.id), '_blank');
                }
            }
        }
    });

    function clusterContextBeans(contextNode) {
        network.cluster({
            joinCondition: function (node) {
                return node.group === 'bean' && node.parentId === contextNode.id;
            },
            clusterNodeProperties: {
                group: 'beanCluster'
            },
            processProperties: function (clusterOptions, childNodes) {
                clusterOptions.label = childNodes.length + " beans...";
                return clusterOptions;
            }
        });
    }

    function queryParams(appName, beanId) {
        var p = {};
        if (appName !== null) {
            p.appName = appName;
        }
        if (beanId !== null) {
            p.beanId = beanId;
        }
        return p;
    }

    function loadAndDrawNetwork() {
		$.get("/smxs/visdata", queryParams(filterAppName, filterBeanId), function(data) {
		    networkData.update(data);

            data.nodes.forEach(function (n) {
                if (n.group === 'rootCtx' || n.group === 'childCtx') {
                    clusterContextBeans(n);
                }
            });
        });

		// var nodes = [
		// 	{id: 1, group: 'app', label: 'ROOT'},
		// 	{id: 2, group : 'rootCtx', label: 'Root \nWebApplicationContext'},
		// 	{id: 3, group : 'childCtx', label: 'WebApplicationContext\n<b>locations:</b> location1;location2'},
		// 	{id: 4, group : 'bean', label: 'SampleBean1'},
		// 	{id: 5, group : 'bean', label: 'SampleBean2'},
		// 	{id: 6, group : 'bean', label: 'SampleBean3'},
		// ];
        //
		// // create an array with edges
		// var edges = [
		// 	{from: 1, to: 2},
		// 	{from: 2, to: 3},
		// 	{from: 2, to: 4},
		// 	{from: 3, to: 5},
		// 	{from: 3, to: 6}
		// ];
        //
		// // provide the data in the vis format
		// var data = {
		// 	nodes: nodes,
		// 	edges: edges
		// };
        //
		// network.setData(data);
    }

    function loadApps() {
        $.get("/smxs/apps", function(data) {
            var $sel = $selApp.empty();
            $sel.append($('<option></option>').attr("value", "null").text("All"));
            data.forEach(function(appName) {
                var option = $('<option></option>').attr("value", appName).text(appName ? appName : 'Global');
                $sel.append(option);
            });
            $selApp.selectpicker('refresh');
        });
    }

    function loadBeanNames() {
        $.get("/smxs/beanNames", queryParams(filterAppName), function(data) {
            var $sel = $selBean.empty();
            $sel.append($('<option></option>').attr("value", "").text("All"));
            data.forEach(function(beanInfo) {
                var option = $('<option></option>').attr("value", beanInfo.id).text(beanInfo.name);
                $sel.append(option);
            });
            $selBean.selectpicker('refresh');
        });
    }

    function reloadBeans() {
        loadBeanNames();
        loadAndDrawNetwork();
    }

    function wireSelectChangedEvents() {
        $("#selApp").on("changed.bs.select", function(e, clickedIndex, isSelected, oldValue) {
            var newValue = $selApp.val();
            filterAppName = newValue === 'null' ? null : newValue;
            filterBeanId = null;
            reloadBeans();
        });
        $("#selBean").on("changed.bs.select", function(e, clickedIndex, isSelected, oldValue) {
            var newValue = $selBean.val();
            filterBeanId = newValue ? newValue : null;
            loadAndDrawNetwork();
        });
    }

    $(document).ready(function () {
        $('.selectpicker').selectpicker();

        loadApps();
        loadBeanNames();
        wireSelectChangedEvents();
        loadAndDrawNetwork();
    });


</script>
</body>
</html>